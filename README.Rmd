---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# refactor

Refactoring code can be a bit scary, what if we mess something up and end up
with a different output or slower code?

Hopefully no more! {refactor} lets you run both the original and refactored 
version of your code and checks whether the output is the same and if it runs
as fast. Then when you're comfortable with your work you can remove the original version.

## Installation

Install with:

``` r
remotes::install_github("moodymudskipper/refactor")
```

## Examples

```{r}
library(refactor)
```

`%refactor%`  by default checks that the output value is consistent between
the original and refactored expressions.

They'll often be used on the body of a function but can be used on any expression.

Here I intend to correct an inefficient use of the `apply()` function,
but used `pmax` incorrectly:

```{r, error=TRUE}
fun1 <- function(data) {
  apply(data, 1, max)
} %refactor% {
  pmax(data)
}
fun1(cars)
```

Now using it correctly:

```{r}
fun2 <- function(data) {
  apply(data, 1, max)
} %refactor% {
  do.call(pmax, data)
}
fun2(cars)
```

We can use the option `refactor.env` to test that the local environment isn't 
changed in different ways by the original and refactored expression.


```{r, error=TRUE}
options("refactor.env" = TRUE)
{
  # original code
  data <- cars
  i <- 1
  apply(data, i, max)
} %refactor% {
  # refactored code
  do.call(pmax, cars)
}
```

We can use the option `refactor.time` to test that the refactored solution is
faster.

```{r, error=TRUE}
# use bigger data so execution time differences are noticeable
cars2 <- do.call(rbind, replicate(1000,cars, F))

options("refactor.time" = TRUE)
fun3 <- function(data) {
  do.call(pmax, data)
} %refactor% {
  apply(data, 1, max)
}
fun3(cars2)

```

## Caveats

We don't control that side effects are the same on both sides, with the exception
of modifications to the local environment. This means
the following for instance might be different in your refactored code 
and you won't be warned about it :

* modified environments (other than local)
* written files
* printed output
* messages
* warnings
* errors

We might be able to support some of those though.

More importantly since both side are run, side effects will be run twice and in some case
this might change the behavior of the program, so use cautiously.
